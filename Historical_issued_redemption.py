import streamlit as st
import pandas as pd
import plotly.express as px

def render():
    # -------------------------------
    data_dict = {
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": [
            "‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏ö‡∏ï./‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á/‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏á‡∏©‡πå",
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà",
            "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô",
            "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå",
            "‡∏™‡∏á‡∏Ç‡∏•‡∏≤",
            "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ",
            "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ",
            "‡∏£‡∏ß‡∏°"
        ],
        "2563_‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": [1431.690111, 105.554447, 12.689767, 18.179667, 65.265115, 51.925549, 27.560583, 1712.865239],
        "2564_‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": [1019.434699, 51.397979, -54.199803, -18.87098, 37.868342, 9.753357, 0.362861, 1045.746455],
        "2565_‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": [1233.244474, 65.831548, -24.91025, -6.302853, 48.364708, 49.396021, -0.380525, 1365.243123],
        "2566_‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": [1260.139013, 74.839027, -96.01845, -34.321229, 24.158003, 25.560733, -38.959581, 1215.397516],
        "2567_‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": [1028.156997, 55.525709, -117.786536, -57.529885, 20.219217, 19.105054, -45.745185, 901.945371],
        "2568_‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": [633.435936, 46.85071, -17.087398, -18.93277, 26.222928, 14.363851, 3.840705, 688.693962],
    }

    # -------------------------------
    # 2. Streamlit UI
    # -------------------------------
    # st.set_page_config(page_title="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ", layout="wide")
    st.title("üìä ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (2563 - 2568)")

    # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô long format
    df = pd.DataFrame(data_dict)
    df_long = df.melt(id_vars="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô", 
                    value_vars=[col for col in df.columns if "‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥" in col],
                    var_name="‡∏õ‡∏µ_‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", 
                    value_name="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥")
    df_long["‡∏õ‡∏µ"] = df_long["‡∏õ‡∏µ_‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"].str.extract(r"(25\d{2})")

    # Filter
    selected_agencies = st.multiselect("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π", df["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"].tolist(), default=df["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"].tolist())
    filtered_df = df_long[df_long["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"].isin(selected_agencies)]

    # -------------------------------
    # 3. Plotly Chart with Text
    # -------------------------------
    fig = px.bar(
        filtered_df,
        x="‡∏õ‡∏µ",
        y="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥",
        color="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
        barmode="group",
        text="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥",
        title="üìå ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏•‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç) ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ",
        height=600
    )

    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    fig.update_traces(textposition='outside', texttemplate="%{text:,.2f}")
    fig.update_layout(
        xaxis_title="‡∏õ‡∏µ",
        yaxis_title="‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏•‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)",
        legend_title="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"
    )
    st.plotly_chart(fig, use_container_width=True)

    # -------------------------------
    # 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    # -------------------------------
    with st.expander("üìã ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á"):
        st.dataframe(filtered_df, use_container_width=True)
        csv = filtered_df.to_csv(index=False).encode("utf-8-sig")
        st.download_button("üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CSV)", csv, "net_payment_by_year.csv")
